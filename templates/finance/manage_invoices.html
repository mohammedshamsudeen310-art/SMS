{% extends "accounts/base_dashboard.html" %}
{% block header %}üßæ Manage Invoices{% endblock %}

{% block content %}
<style>
  /* ====== Invoice Management Styling ====== */
  .content-card {
    background: #ffffff;
    padding: 25px 30px;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
    animation: fadeIn 0.5s ease-in-out;
  }

  .content-card h2 {
    margin-bottom: 20px;
    color: #333;
    font-size: 1.5rem;
  }

  .summary {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    background: #f7faff;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 25px;
    border: 1px solid #e0e6f1;
  }

  .summary p {
    font-size: 1rem;
    font-weight: 500;
    margin: 8px 0;
    color: #222;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
  }

  .table th, .table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }

  .table th {
    background: #f0f4ff;
    color: #333;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
  }

  .table tr:hover {
    background: #f9fbff;
    transition: background 0.3s ease;
  }

  .badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    color: white;
  }

  .badge.success { background: #28a745; }
  .badge.warning { background: #ffc107; color: #222; }

  .no-data {
    text-align: center;
    padding: 25px;
    font-style: italic;
    color: #888;
  }

  /* ====== Buttons ====== */
  .btn {
    display: inline-block;
    padding: 6px 10px;
    font-size: 0.85rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    margin-right: 4px;
    transition: background 0.2s ease;
  }

  .btn-primary { background: #007bff; color: #fff; }
  .btn-warning { background: #ffc107; color: #222; }
  .btn-danger  { background: #dc3545; color: #fff; }

  .btn:hover { opacity: 0.85; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="content-card">
  <h2>All Invoices</h2>

  <div class="summary">
    <p><strong>Total Due:</strong> ‚Çµ{{ total_due }}</p>
    <p><strong>Total Paid:</strong> ‚Çµ{{ total_paid }}</p>
    <p><strong>Total Balance:</strong> ‚Çµ{{ total_balance }}</p>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Invoice No.</th>
        <th>Student</th>
        <th>Session</th>
        <th>Term</th>
        <th>Total Due</th>
        <th>Paid</th>
        <th>Balance</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for inv in invoices %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ inv.invoice_number }}</td>
        <td>{{ inv.student.full_name }}</td>
        <td>{{ inv.session }}</td>
        <td>{{ inv.term }}</td>
        <td>‚Çµ{{ inv.total_due }}</td>
        <td>‚Çµ{{ inv.total_paid }}</td>
        <td>‚Çµ{{ inv.balance }}</td>
        <td>
          {% if inv.is_paid %}
            <span class="badge success">Paid</span>
          {% else %}
            <span class="badge warning">Pending</span>
          {% endif %}
        </td>
        <td>
          <a href="{% url 'edit_invoice' inv.id %}" class="btn btn-warning">‚úèÔ∏è Edit</a>
          <a href="{% url 'delete_invoice' inv.id %}" class="btn btn-danger"
             onclick="return confirm('Are you sure you want to delete this invoice?');">üóëÔ∏è Delete</a>

          {% if inv.id %}
            <a href="{% url 'download_invoice_pdf' inv.id %}" class="btn btn-primary">‚¨á Download</a>
          {% else %}
            <span class="btn btn-primary" style="opacity:0.6;cursor:not-allowed;">No PDF</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="10" class="no-data">No invoices found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
/*
  üîÑ Live invoice refresh:
  Fetches /invoices/json/ and updates summary + table dynamically.
  Runs every 30 seconds and on tab focus.
*/

async function fetchInvoicesAndRender() {
  try {
    const res = await fetch("{% url 'invoices_json' %}");
    if (!res.ok) throw new Error("Network response not ok");
    const data = await res.json();

    // ‚úÖ Update summary
    const summaryEl = document.querySelector(".summary");
    if (summaryEl) {
      summaryEl.innerHTML = `
        <p><strong>Total Due:</strong> ‚Çµ${Number(data.summary.total_due).toFixed(2)}</p>
        <p><strong>Total Paid:</strong> ‚Çµ${Number(data.summary.total_paid).toFixed(2)}</p>
        <p><strong>Total Balance:</strong> ‚Çµ${Number(data.summary.total_balance).toFixed(2)}</p>
      `;
    }

    // ‚úÖ Update table
    const tbody = document.querySelector("table.table tbody");
    if (!tbody) return;

    if (!data.invoices || data.invoices.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10" class="no-data">No invoices found.</td></tr>`;
      return;
    }

    // Build each row
    const rowsHtml = data.invoices.map((inv, idx) => {
      const statusBadge = inv.is_paid
        ? '<span class="badge success">Paid</span>'
        : '<span class="badge warning">Pending</span>';

      const total_due = Number(inv.total_due || 0).toFixed(2);
      const total_paid = Number(inv.total_paid || 0).toFixed(2);
      const balance = Number(inv.balance || 0).toFixed(2);

      // ‚úÖ Includes Edit, Delete, and Download buttons dynamically
      const downloadBtn = inv.id
        ? `<a href="/finance/invoice/${inv.id}/download/" class="btn btn-primary">‚¨á Download</a>`
        : `<span class="btn btn-primary" style="opacity:0.6;cursor:not-allowed;">No PDF</span>`;

      return `
        <tr data-invoice-id="${inv.id || ''}">
          <td>${idx + 1}</td>
          <td>${inv.invoice_number || ""}</td>
          <td>${inv.student_name || ""}</td>
          <td>${inv.session || ""}</td>
          <td>${inv.term || ""}</td>
          <td>‚Çµ${total_due}</td>
          <td>‚Çµ${total_paid}</td>
          <td>‚Çµ${balance}</td>
          <td>${statusBadge}</td>
          <td>
            <a href="/finance/invoice/${inv.id}/edit/" class="btn btn-warning">‚úèÔ∏è Edit</a>
            <a href="/finance/invoice/${inv.id}/delete/" class="btn btn-danger"
               onclick="return confirm('Are you sure you want to delete this invoice?');">üóëÔ∏è Delete</a>
            ${downloadBtn}
          </td>
        </tr>
      `;
    }).join("");

    tbody.innerHTML = rowsHtml;

  } catch (err) {
    console.error("fetchInvoicesAndRender error:", err);
  }
}

// üîÅ Auto-refresh setup
fetchInvoicesAndRender();
const INVOICES_REFRESH_MS = 30000;
setInterval(fetchInvoicesAndRender, INVOICES_REFRESH_MS);
window.addEventListener("focus", fetchInvoicesAndRender);
</script>

{% endblock %}
